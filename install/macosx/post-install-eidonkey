#!/bin/bash -x

# Post Installation
# Generate SSL key pairs for the service 
eidonkey --gencert

# Add certificate to the truststore of the OS
# Apple KeyChain
sudo openssl asn1parse -in cacert.crt -inform PEM -out cacert.der
# Remove your old CA Certificate
sudo security delete-certificate -c "My eidonkey CA" /Library/Keychains/System.keychain
# Add your old CA Certificate
sudo security add-trusted-cert -d -r trustRoot -k "/Library/Keychains/System.keychain" cacert.der
# Remove the der version of the old CA Certificate
sudo rm -f cacert.der
sudo rm -f cert.der

# Open personal FW to allow connections to the service
# Add the application to the Application firewall of Apple 
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add $HOME/Applications/eidonkey
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp $HOME/Applications/eidonkey

# Add to Firefox keystore
# download nss sources with nsrp (version 3.23)
# >cd nss-3.23/NSS
# >make nss_build_all
# copy files for certutil:
# >cp ./nspr/LICENSE ../eidonkey/install/macosx/firefox
# >cp ./nspr/Darwin15.5.0_DBG.OBJ/lib/ds/libplds4.dylib ../eidonkey/install/macosx/firefox
# >cp ./nspr/Darwin15.5.0_DBG.OBJ/lib/libc/src/libplc4.dylib ../eidonkey/install/macosx/firefox
# >cp ./nspr/Darwin15.5.0_DBG.OBJ/pr/src/libnspr4.dylib ../eidonkey/install/macosx/firefox
# >cp ./nss/COPYING ../eidonkey/install/macosx/firefox
# >cp ./nss/lib/ssl/Darwin15.5.0_DBG.OBJ/libssl3.dylib ../eidonkey/install/macosx/firefox
# >cp ./nss/lib/smime/Darwin15.5.0_DBG.OBJ/libsmime3.dylib ../eidonkey/install/macosx/firefox
# >cp ./nss/lib/nss/Darwin15.5.0_DBG.OBJ/libnss3.dylib ../eidonkey/install/macosx/firefox
# >cp ./nss/lib/util/Darwin15.5.0_DBG.OBJ/libnssutil3.dylib ../eidonkey/install/macosx/firefox
# >cp ./nss/cmd/certutil/Darwin15.5.0_DBG.OBJ/certutil ../eidonkey/install/macosx/firefox
# >cp ./nss/lib/softoken/Darwin15.5.0_DBG.OBJ/libsoftokn3.dylib ../eidonkey/install/macosx/firefox
# >cp ./nss/lib/softoken/legacydb/Darwin15.5.0_DBG.OBJ/libnssdbm3.dylib ../eidonkey/install/macosx/firefox
# >cp ./nss/lib/freebl/Darwin15.5.0_DBG.OBJ/Darwin_SINGLE_SHLIB/libfreebl3.dylib ../eidonkey/install/macosx/firefox

# Add the certificates to the Firefox truststore
cd firefox
for dir in ~/Library/Application\ Support/Firefox/Profiles/*
do
	if [ -d "${dir}" ]
	then
		# ignore: remove certificate gives error SEC_ERROR_LEGACY_DATABASE, when certificate not found
		./certutil -D -n "My eidonkey CA" -d "${dir}"
		./certutil -A -n "My eidonkey CA" -t Cc,, -i ../cacert.crt -d "${dir}"
	fi
done
cd ..

# Sign the components
shasum -a 256 -t post-install-eidonkey > eidonkey.sig
shasum -b -a 256 -b eidonkey >> eidonkey.sig
shasum -b -a 256 -b eid_pin >> eidonkey.sig

# Secure access to application directory and applications
chmod 500 eidonkey
chmod 500 eid_pin
chmod 500 eidonkey.sig
chmod 400 cert.key
chmod 444 cert.crt
chmod 444 cacert.crt
chmod 500 post-install-eidonkey
